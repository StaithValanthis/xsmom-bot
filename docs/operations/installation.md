# Installation Guide

Complete installation guide for xsmom-bot on Ubuntu with systemd.

---

## Overview

The xsmom-bot installer (`install.sh`) is a **one-shot installer** that:

1. Installs system dependencies (Python, pip, git)
2. Creates virtual environment and installs Python packages
3. Sets up directory structure (`logs/`, `state/`, `data/`, etc.)
4. Prompts for secrets (API keys, Discord webhook)
5. Installs and enables systemd services and timers
6. Validates installation

**Result:** Fully configured bot ready to run, with all services enabled.

---

## System Requirements

### Minimum Requirements

- **OS**: Ubuntu 20.04+ (or similar Linux distribution)
- **Python**: 3.10+ with `venv` support
- **RAM**: 2GB+ (4GB+ recommended)
- **Disk**: 10GB+ free space
- **Network**: Internet connection for exchange API

### Required System Packages

The installer will auto-install these if missing:

- `python3` - Python interpreter
- `python3-venv` - Virtual environment support
- `python3-pip` - Python package manager
- `git` - Version control (for updates)

**Note:** The installer requires `sudo` access to install packages and systemd services.

---

## Installation Steps

### Step 1: Clone Repository

```bash
git clone <repository-url>
cd xsmom-bot
```

### Step 2: Run Installer

```bash
chmod +x install.sh
./install.sh
```

**What happens:**

1. **Pre-flight checks:**
   - Verifies Python, pip, git, sudo, systemctl
   - Auto-installs missing packages (if `AUTO_INSTALL_PACKAGES=1`)

2. **Project setup:**
   - Creates `/opt/xsmom-bot` directory (or `$HOME/xsmom-bot-app` if `/opt` unavailable)
   - Copies repository files to installation directory
   - Creates required subdirectories (`logs/`, `state/`, `data/`, `config/optimized/`, `reports/`)

3. **Python environment:**
   - Creates virtual environment at `/opt/xsmom-bot/venv`
   - Upgrades pip and wheel
   - Installs all dependencies from `requirements.txt`

4. **Configuration:**
   - Copies `config/config.yaml.example` â†’ `config/config.yaml` (if missing)
   - Creates `.env.example` template

5. **Secrets configuration:**
   - Prompts for:
     - **Bybit API Key** (required)
     - **Bybit API Secret** (required, hidden input)
     - **Discord Webhook URL** (optional)
   - Writes to `/opt/xsmom-bot/.env` with restrictive permissions (mode 600)

6. **Systemd services:**
   - Installs service files to `/etc/systemd/system/`:
     - `xsmom-bot.service` (main trading bot)
     - `xsmom-optimizer.service` + `.timer` (nightly optimization)
     - `xsmom-meta-trainer.service` + `.timer` (daily meta-label training)
     - `xsmom-daily-report.service` + `.timer` (daily performance reports)
     - `xsmom-rollout-supervisor.service` + `.timer` (staging/promotion lifecycle)
   - Runs `systemctl daemon-reload`
   - Enables all services and timers
   - Starts timers (services run on schedule)

7. **Validation:**
   - Checks venv exists
   - Validates `.env` has API keys
   - Runs smoke test (Python imports)
   - Tests config loading
   - Tests CLI (`--help`)

8. **Service start:**
   - Prompts whether to start bot service immediately
   - If yes, starts `xsmom-bot.service`

---

## Installation Directory Structure

After installation, `/opt/xsmom-bot` contains:

```
/opt/xsmom-bot/
â”œâ”€â”€ .env                    # Secrets (API keys, webhook) - NEVER COMMIT
â”œâ”€â”€ .env.example            # Template for .env
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.yaml         # Main config (copied from example)
â”‚   â”œâ”€â”€ config.yaml.example # Example config
â”‚   â””â”€â”€ optimized/          # Optimized configs (generated by optimizer)
â”œâ”€â”€ src/                    # Source code
â”œâ”€â”€ systemd/                 # Systemd unit files
â”œâ”€â”€ logs/                   # Log files
â”œâ”€â”€ state/                  # State files (positions, equity history)
â”œâ”€â”€ data/                   # Rollout state, metrics
â”œâ”€â”€ reports/                # Optimizer reports
â”œâ”€â”€ venv/                   # Python virtual environment
â”œâ”€â”€ bin/                    # Helper scripts
â”œâ”€â”€ docs/                   # Documentation
â””â”€â”€ requirements.txt        # Python dependencies
```

---

## Secrets Management

### Environment Variables (`.env` file)

Secrets are stored in `/opt/xsmom-bot/.env`:

```bash
# Bybit API Credentials (REQUIRED)
BYBIT_API_KEY=your_api_key_here
BYBIT_API_SECRET=your_api_secret_here

# Discord Webhook URL (OPTIONAL)
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...

# Python environment
PYTHONUNBUFFERED=1
```

**Security:**
- File permissions: `600` (read/write for owner only)
- Owner: `ubuntu` (or configured `RUN_AS` user)
- **Never commit `.env` to git** (it's in `.gitignore`)

### How Secrets Are Used

**Bybit API Keys:**
- Read by `src/exchange.py` via `os.getenv("BYBIT_API_KEY")` and `os.getenv("BYBIT_API_SECRET")`
- Also accepts `API_KEY` and `API_SECRET` as aliases
- Loaded by systemd services via `EnvironmentFile=/opt/xsmom-bot/.env`

**Discord Webhook:**
- Primary: `DISCORD_WEBHOOK_URL` environment variable (from `.env`)
- Fallback: `notifications.discord.webhook_url` in `config/config.yaml`
- Used by `src/notifications/discord_notifier.py`

---

## Systemd Services

### Main Bot Service

**File:** `/etc/systemd/system/xsmom-bot.service`

**Purpose:** Runs the main trading bot 24/7

**Status:**
```bash
sudo systemctl status xsmom-bot.service
```

**Logs:**
```bash
journalctl -u xsmom-bot.service -f
```

**Commands:**
```bash
sudo systemctl start xsmom-bot.service    # Start
sudo systemctl stop xsmom-bot.service     # Stop
sudo systemctl restart xsmom-bot.service  # Restart
sudo systemctl enable xsmom-bot.service   # Enable on boot
```

**Default:** Runs with `--dry` flag (paper trading). Remove `--dry` from service file for live trading.

### Optimizer Service + Timer

**Files:**
- `/etc/systemd/system/xsmom-optimizer.service`
- `/etc/systemd/system/xsmom-optimizer.timer`

**Purpose:** Runs full-cycle optimizer (WFO + Bayesian + Monte Carlo) on schedule

**Schedule:** Daily at 00:30 UTC (configurable via `OPTIMER_CALENDAR`)

**Status:**
```bash
sudo systemctl status xsmom-optimizer.timer
systemctl list-timers | grep xsmom-optimizer
```

**Logs:**
```bash
journalctl -u xsmom-optimizer.service -f
```

### Meta-Trainer Service + Timer

**Files:**
- `/etc/systemd/system/xsmom-meta-trainer.service`
- `/etc/systemd/system/xsmom-meta-trainer.timer`

**Purpose:** Trains meta-labeler model daily

**Schedule:** Daily at 01:20 UTC (configurable via `META_CALENDAR`)

**Status:**
```bash
sudo systemctl status xsmom-meta-trainer.timer
```

### Daily Report Service + Timer

**Files:**
- `/etc/systemd/system/xsmom-daily-report.service`
- `/etc/systemd/system/xsmom-daily-report.timer`

**Purpose:** Sends daily performance report to Discord

**Schedule:** Daily at 00:05 UTC

**Status:**
```bash
sudo systemctl status xsmom-daily-report.timer
```

**Logs:**
```bash
journalctl -u xsmom-daily-report.service -f
```

### Rollout Supervisor Service + Timer

**Files:**
- `/etc/systemd/system/xsmom-rollout-supervisor.service`
- `/etc/systemd/system/xsmom-rollout-supervisor.timer`

**Purpose:** Manages staging/promotion lifecycle for optimized configs

**Schedule:** Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)

**Status:**
```bash
sudo systemctl status xsmom-rollout-supervisor.timer
```

**Logs:**
```bash
journalctl -u xsmom-rollout-supervisor.service -f
```

---

## Configuration

### Main Config File

**Location:** `/opt/xsmom-bot/config/config.yaml`

**Source:** Copied from `config/config.yaml.example` during installation

**Key Settings:**
- `exchange.testnet`: `true` for testnet, `false` for production
- `risk.max_daily_loss_pct`: Daily loss limit (default: 5.0%)
- `strategy.gross_leverage`: Portfolio leverage (default: 0.95)
- `notifications.discord.enabled`: Enable Discord notifications

**Edit:**
```bash
sudo nano /opt/xsmom-bot/config/config.yaml
```

**After changes:** Restart bot service
```bash
sudo systemctl restart xsmom-bot.service
```

### Environment Variables

**Location:** `/opt/xsmom-bot/.env`

**Edit:**
```bash
sudo nano /opt/xsmom-bot/.env
```

**After changes:** Restart services to reload environment
```bash
sudo systemctl restart xsmom-bot.service
```

---

## Verification

### Quick Verification

```bash
# 1. Check services are installed
systemctl list-units | grep xsmom

# 2. Check timers are active
systemctl list-timers | grep xsmom

# 3. Check bot service status
sudo systemctl status xsmom-bot.service

# 4. Check .env has API keys
sudo cat /opt/xsmom-bot/.env | grep BYBIT_API_KEY

# 5. Test Python imports
sudo -u ubuntu /opt/xsmom-bot/venv/bin/python -c "from src.config import load_config; print('OK')"

# 6. Test config loading
sudo -u ubuntu /opt/xsmom-bot/venv/bin/python -c "from src.config import load_config; cfg = load_config('/opt/xsmom-bot/config/config.yaml'); print(f'Config OK: {cfg.exchange.max_symbols} symbols')"
```

### Full Verification

```bash
# 1. Check all services
sudo systemctl status xsmom-bot.service
sudo systemctl status xsmom-optimizer.timer
sudo systemctl status xsmom-meta-trainer.timer
sudo systemctl status xsmom-daily-report.timer
sudo systemctl status xsmom-rollout-supervisor.timer

# 2. Check all timers
systemctl list-timers | grep xsmom

# 3. Check bot logs (should show startup)
journalctl -u xsmom-bot.service -n 50

# 4. Test CLI
sudo -u ubuntu /opt/xsmom-bot/venv/bin/python -m src.main --help

# 5. Test config
sudo -u ubuntu /opt/xsmom-bot/venv/bin/python -c "
from src.config import load_config
cfg = load_config('/opt/xsmom-bot/config/config.yaml')
print(f'âœ“ Config loaded: {cfg.exchange.max_symbols} symbols, testnet={cfg.exchange.testnet}')
"
```

---

## Idempotency

The installer is **idempotent** - safe to run multiple times:

- **Virtual environment:** Reuses existing venv if present
- **Config file:** Only creates if missing (won't overwrite existing)
- **`.env` file:** Prompts before overwriting if keys already exist
- **Systemd services:** Reinstalls/updates service files (safe to re-run)
- **Permissions:** Always sets correct permissions

**Re-running installer:**
```bash
./install.sh
# Will prompt: "Overwrite existing .env?" if keys already exist
```

---

## Non-Interactive Installation

For automated deployments:

```bash
RUN_NONINTERACTIVE=1 START_NOW=no ./install.sh
```

**Behavior:**
- Skips secret prompts (assumes `.env` already exists or will be created manually)
- Doesn't prompt to start service
- Still installs all services and timers

---

## Troubleshooting

### "Python 3 not found"

**Fix:** Install Python 3:
```bash
sudo apt-get update
sudo apt-get install python3 python3-venv python3-pip
```

Or set `AUTO_INSTALL_PACKAGES=1` (default) to auto-install.

### "sudo not found"

**Fix:** Install sudo or run installer as root (not recommended).

### "systemctl not found"

**Fix:** Install systemd (usually pre-installed on Ubuntu). Services won't be installed, but bot can still run manually.

### ".env file missing API keys"

**Fix:** Edit `.env` manually:
```bash
sudo nano /opt/xsmom-bot/.env
# Add:
# BYBIT_API_KEY=your_key
# BYBIT_API_SECRET=your_secret
```

### "Service fails to start"

**Check logs:**
```bash
journalctl -u xsmom-bot.service -n 100
```

**Common issues:**
- Missing API keys in `.env`
- Invalid config in `config/config.yaml`
- Network connectivity issues

### "Timer not running"

**Check timer status:**
```bash
systemctl status xsmom-optimizer.timer
systemctl list-timers | grep xsmom
```

**Enable and start:**
```bash
sudo systemctl enable xsmom-optimizer.timer
sudo systemctl start xsmom-optimizer.timer
```

---

## Next Steps

After installation:

1. **Review Config:** Edit `/opt/xsmom-bot/config/config.yaml`
2. **Test on Testnet:** Set `exchange.testnet: true`
3. **Start Bot:** `sudo systemctl start xsmom-bot.service`
4. **Monitor Logs:** `journalctl -u xsmom-bot.service -f`
5. **Check Timers:** `systemctl list-timers | grep xsmom`

**Documentation:**
- **Quick Start:** [`../overview/quickstart.md`](../overview/quickstart.md)
- **Config Reference:** [`../reference/config_reference.md`](../reference/config_reference.md)
- **Deployment:** [`deployment_ubuntu_systemd.md`](deployment_ubuntu_systemd.md)
- **Troubleshooting:** [`troubleshooting.md`](troubleshooting.md)

---

**Motto: MAKE MONEY** â€” with a fully automated, one-shot installation. ðŸš€

